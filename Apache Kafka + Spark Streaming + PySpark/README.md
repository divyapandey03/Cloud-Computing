# Introduction:

Apache Kafka is a distributed data store optimized for ingesting and processing streaming data in real-time. Streaming data is data that is continuously generated by thousands of data sources, which typically send the data records in simultaneously. A streaming platform needs to handle this constant influx of data, and process the data sequentially and incrementally.

Kafka provides three main functions to its users:

- Publish and subscribe to streams of records
- Effectively store streams of records in the order in which records were generated
- Process streams of records in real time


Kafka is primarily used to build real-time streaming data pipelines and applications that adapt to the data streams. It combines messaging, storage, and stream processing to allow storage and analysis of both historical and real-time data.  

We use Apache Kafka in a Linux environment in GCP Platform and reveals how events are consumed and produced using a Kafka-Python.The following diagram illustrates the Kafka ecosystem we’re going to set up.

<img width="553" alt="kafkaimage" src="https://user-images.githubusercontent.com/23255126/205745054-63ed168b-f050-48b4-9cbf-3089f193787e.png">

## Spark Streaming:

Spark Streaming is an extension of the core Spark API that enables scalable, high-throughput, fault-tolerant stream processing of live data streams. Data can be ingested from many sources like Kafka, Kinesis, or TCP sockets, and can be processed using complex algorithms expressed with high-level functions like map, reduce, join and window. Finally, processed data can be pushed out to filesystems, databases, and live dashboards. In fact, you can apply Spark’s machine learning and graph processing algorithms on data streams.


<img width="529" alt="d1" src="https://user-images.githubusercontent.com/23255126/205745887-a26b48ce-1dbf-455c-acf6-558bd57b6be4.png">

Internally, it works as follows. Spark Streaming receives live input data streams and divides the data into batches, which are then processed by the Spark engine to generate the final stream of results in batches.

<img width="467" alt="d2" src="https://user-images.githubusercontent.com/23255126/205746024-8ec81aff-5f56-4150-a84e-db670f810d52.png">

## Installing Spark
- Step : Download spark-2.3.2 to the local machine using the following command:
   -  $ wget https://dlcdn.apache.org/spark/spark-3.3.1/spark-3.3.1-bin-hadoop3.tgz

- Step : Unpack
    - $ tar -xvf spark-3.3.1-bin-hadoop3.tgz

<img width="646" alt="g2" src="https://user-images.githubusercontent.com/23255126/205775687-0b33ab76-ea95-4c1c-8007-4a721e545ad9.png">

- create a soft link:
  - ln -s /home/dpandey/spark-3.3.1-bin-hadoop3 /home/dpandey/spark

### Add SPARK_HOME entry to bashrc

export SPARK_HOME=/home/dpandey/spark

export PATH=$SPARK_HOME/bin:$PATH

export PATH=$SPARK_HOME/sbin:$PATH


### Load bashrc file 
 source ~/.bashrc
 
### Install Java

- sudo apt-get update
- sudo apt install default-jdk
- java --version
- update-alternatives --list java
- export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64/bin/java

### Verify the installation
   $ pyspark
   
   <img width="857" alt="g3" src="https://user-images.githubusercontent.com/23255126/205776226-180c98ae-86ac-45b4-ac44-22290cbef18a.png">
   
   ###  Start the master in this machine
   -  start-master.sh
   -  URL: http://34.70.113.82:8080/

<img width="475" alt="g4" src="https://user-images.githubusercontent.com/23255126/205776524-9d4ae2e9-5725-4188-89a1-0a9cf28c6239.png">




<img width="935" alt="g5" src="https://user-images.githubusercontent.com/23255126/205776531-52c529c2-8b28-47b6-b91a-bc96029d306f.png">

### Starting worker

- start-slave.sh spark://34.70.113.82:7077
- browse URL: http://34.70.113.82:8080/


<img width="956" alt="g6" src="https://user-images.githubusercontent.com/23255126/205776779-80516bba-480a-45eb-bcd0-140b3b861741.png">


### Run WordCount Example in Python:

Terminal 1:Keep Session on
- nc -lk 9999


<img width="202" alt="g10" src="https://user-images.githubusercontent.com/23255126/205777220-bab6d97e-4477-40f4-adb1-58921cf7ce57.png">

Terminal 2:
-  cd spark
- ./bin/spark-submit examples/src/main/python/streaming/network_wordcount.py localhost 9999


You will see output like this:

<img width="446" alt="g7" src="https://user-images.githubusercontent.com/23255126/205777270-a4697ead-2465-4c65-bff6-2aaa0ad9cf68.png">



<img width="470" alt="g8" src="https://user-images.githubusercontent.com/23255126/205777287-15297984-3059-42aa-a058-c6865faef4d1.png">

<img width="463" alt="g9" src="https://user-images.githubusercontent.com/23255126/205777357-9f61268c-77e5-4524-8a1f-4f7578c33517.png">

# Starting Kafka

 -  Download Kafka: wget https://downloads.apache.org/kafka/3.3.1/kafka_2.12-3.3.1.tgz
 -   tar -xvf kafka_2.12-3.3.1.tgz
 -  Go to Kafka root folder
 -  Start Kafka Zookeeper(Terminal 1-Keep Session on)
       
       

<img width="392" alt="g11" src="https://user-images.githubusercontent.com/23255126/205777756-786c0751-7a1f-45fb-b1bb-62efa913efaf.png">


- Start Kafka Brokers(Open another Terminal 2)


<img width="410" alt="g12" src="https://user-images.githubusercontent.com/23255126/205777817-55499133-f02f-46df-941a-36eac2ada4b6.png">

- Create two Kafka Topics (input_event and output_event)
   - bin/kafka-topics.sh --create --topic input_event --zookeeper localhost:2181 --partitions 3 --replication-factor 1
   - bin/kafka-topics.sh --create --topic output_event --zookeeper localhost:2181 --partitions 3 --replication-factor 1
 
 - Setup Spark:
   - sudo apt install python3-pip
   - pip3 install msgpack
   - pip3 install kafka-python
   
 - Code for producing the events(producer.py)
   - cd kafka_2.12-3.3.1
   - create producer.py file

 
 <img width="467" alt="k2" src="https://user-images.githubusercontent.com/23255126/205778789-47947679-b559-488a-84a2-67af18e52604.png">

 - Code for Consuming the events(consumer.py)
   - cd kafka_2.12-3.3.1
   - create consumer.py file
  
<img width="326" alt="k1" src="https://user-images.githubusercontent.com/23255126/205778797-a8ddcf16-004a-4cec-97a8-0902c6d43409.png">


- Run (Terminal 3):

 - /bin/python3 consumer.py

- Run (Terminal 4)
  - /bin/python3 producer.py
  
  
<img width="347" alt="g15" src="https://user-images.githubusercontent.com/23255126/205779204-8eca40b4-4083-4a23-aad4-bc4e70fe81dd.png">


You will see output like this in consumer.py Terminal 3:


<img width="487" alt="g16" src="https://user-images.githubusercontent.com/23255126/205779275-5415a1e0-fe85-4278-8b09-260e629a3522.png">

### Create and Submit Spark Application:
- Create pyspark_script directory: mkdir pyspark_script
- cd pyspark_script
- Download spark application file from this link: https://github.com/divyapandey03/Cloud-Computing/blob/main/Apache%20Kafka%20%2B%20Spark%20Streaming%20%2B%20PySpark/spark_processor.py
- Download Spark Streaming’s Kafka libraries:  wget https://repo1.maven.org/maven2/org/apache/spark/spark-streaming-kafka-0-8-assembly_2.11/2.3.2/spark-streaming-kafka-0-8-assembly_2.11-2.3.2.jar

### Submit the spark Application:
- spark-submit --jars /home/dpandey/pyspark_script/spark-streaming-kafka-0-8-assembly_2.11-2.3.2.jar --master spark:34.70.113.82:7077 --deploy-mode client /home/dpandey/spark_processor.py

## Presentation Link: https://docs.google.com/presentation/d/1Nk6KPRh4Os5b4YGgGoxjtBPTYR7MkTJq/edit?usp=sharing&ouid=115854624782305611491&rtpof=true&sd=true
